<!DOCTYPE html>
<html>
<head>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Light Up L3</title>
<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
<style>
body {
  font: 10px sans-serif;
  margin: 0;
  overflow: hidden;
  -webkit-tap-highlight-color: rgba(0,0,0,0);
}
</style>
    </head>
    <body>
    <img id="img" src="test0.jpg">
<canvas id="canvas" style="position:absolute; left: 0; top: 0;"></canvas>
</body>
<script>
var ws;
function ws_connect() {
    if(ws == null) {
        ws = new WebSocket("ws://" + location.host + "/ws");
        ws.onmessage = function(event) {
            data = JSON.parse(event.data)
            if(data.msg == 'bg') {
                document.body.style.backgroundColor = data.color;
            } else if(data.msg = 'rect') {
                var c = document.getElementById("canvas")
                 if(c.height != data.shape[0] || c.width != data.shape[1]) {
                     c.height = data.shape[0]
                     c.width = data.shape[1]
                 }
                var cx = c.getContext("2d");
                cx.moveTo(data.rect[0][0], data.rect[0][1])
                cx.lineTo(data.rect[1][0], data.rect[1][1])
                cx.lineTo(data.rect[2][0], data.rect[2][1])
                cx.lineTo(data.rect[3][0], data.rect[3][1])
                cx.closePath()
                cx.strokeStyle="lightgreen";
                cx.lineWidth= 3;
                cx.setLineDash([5, 15]);
                //cx.stroke();

                deltaX = data.rect[2][0] - data.rect[1][0];
                deltaY = data.rect[2][1] - data.rect[1][1];

                scale = window.innerWidth / deltaX;
                console.log(scale)

                document.getElementById("img").style.transformOrigin=data.rect[1][0] + "px " +  data.rect[1][1] + "px";
                document.getElementById("canvas").style.transformOrigin=data.rect[1][0] + "px " +  data.rect[1][1] + "px";
                document.getElementById("img").style.transform = "translate(" + (-data.rect[1][0]) + "px, " + (-data.rect[1][1]) + "px) rotate(" + - Math.atan(deltaY / deltaX) + "rad) scale(" + scale + ")";
                document.getElementById("canvas").style.transform = "translate(" + (-data.rect[1][0]) + "px, " + (-data.rect[1][1]) + "px) rotate(" + - Math.atan(deltaY / deltaX) + "rad) scale(" + scale + ")";
            }
            //console.log(event.data.length);
            //document.getElementById("apa").src = "data:image/jpg;base64," + event.data;
            // document.body.innerHTML = "<img src='/test.png'/>";
        }
        ws.onclose = function(event) {
            console.log("WS closed");
            ws = null;
        }
        ws.onerror = function(event) {
            ws = null;
        }
    }
}
ws_connect();
function ws_send(msg) {
    var json = JSON.stringify(msg);
    if(ws == null) {
        ws_connect();
        ws.onopen = function(event) {
            ws.send(json);
        }
    } else {
        ws.send(json);
    }
}
</script>
</html>
